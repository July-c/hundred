<?php// +----------------------------------------------------------------------// | Common // +----------------------------------------------------------------------// | 版权所有 2015-2020 武汉市微易科技有限公司，并保留所有权利。// +----------------------------------------------------------------------// | 网站地址: https://www.kdfu.cn// +----------------------------------------------------------------------// | 这不是一个自由软件！您只能在不用于商业目的的前提下使用本程序// +----------------------------------------------------------------------// | 不允许对程序代码以任何形式任何目的的再发布// +----------------------------------------------------------------------// | Author: 微小易    Date: 2018-12-01// +----------------------------------------------------------------------namespace app\common\service\qrcode;use Grafika\Color;use Grafika\Grafika;class Item extends Base{    /* @var \app\common\model\Item $Item */    private $Item;    private $user_id;    private $posterName;    private $posterPath;    private $posterUrl;    /**     * 构造方法     * Poster constructor.     * @param $Item     * @param $user     * @throws \Exception     */    public function __construct($Item, $user)    {        parent::__construct();        // 商品信息        $this->Item = $Item;        // 当前用户id        $this->user_id = $user ? $user['user_id'] : 0;    }    /**     * @return mixed     * @throws \app\common\exception\BaseException     * @throws \think\exception\DbException     * @throws \Exception     */    public function getImage()    {        // 判断海报图文件存在则直接返回url        if (file_exists($this->getPosterPath())) {            return $this->getPosterUrl();        }        // 小程序id        $appId = $this->item['app_id'];        // 商品海报背景图        $backdrop = __DIR__ . '/resource/item_bg.png';        // 下载商品首图        $itemUrl = $this->saveTempImage($appId, $this->item['image'][0]['file_path'], 'item');        // 下载小程序码        $scene = "gid:{$this->item['item_id']},uid:" . ($this->user_id ?: '');        $qrcode = $this->saveQrcode($appId, $scene, 'pages/item/index');        // 拼接海报图        return $this->savePoster($backdrop, $itemUrl, $qrcode);    }    /**     * 拼接海报图     * @param $backdrop     * @param $itemUrl     * @param $qrcode     * @return string     * @throws \Exception     */    private function savePoster($backdrop, $itemUrl, $qrcode)    {        // 实例化图像编辑器        $editor = Grafika::createEditor(['Gd']);        // 字体文件路径        $fontPath = Grafika::fontsDir() . '/' . 'st-heiti-light.ttc';        // 打开海报背景图        $editor->open($backdropImage, $backdrop);        // 打开商品图片        $editor->open($itemImage, $itemUrl);        // 重设商品图片宽高        $editor->resizeExact($itemImage, 690, 690);        // 商品图片添加到背景图        $editor->blend($backdropImage, $itemImage, 'normal', 1.0, 'top-left', 30, 30);        // 商品名称处理换行        $fontSize = 30;        $Name = $this->wrapText($fontSize, 0, $fontPath, $this->item['name'], 680, 2);        // 写入商品名称        $editor->text($backdropImage, $Name, $fontSize, 30, 750, new Color('#333333'), $fontPath);        // 写入商品价格        $editor->text($backdropImage, $this->item['sku'][0]['item_price'], 38, 62, 964, new Color('#ff4444'));        // 打开小程序码        $editor->open($qrcodeImage, $qrcode);        // 重设小程序码宽高        $editor->resizeExact($qrcodeImage, 140, 140);        // 小程序码添加到背景图        $editor->blend($backdropImage, $qrcodeImage, 'normal', 1.0, 'top-left', 570, 914);        // 保存图片        $editor->save($backdropImage, $this->getPosterPath());        return $this->getPosterUrl();    }    /**     * 处理文字超出长度自动换行     * @param integer $fontsize 字体大小     * @param integer $angle 角度     * @param string $fontface 字体名称     * @param string $string 字符串     * @param integer $width 预设宽度     * @param null $max_line 最多行数     * @return string     */    private function wrapText($fontsize, $angle, $fontface, $string, $width, $max_line = null)    {        // 这几个变量分别是 字体大小, 角度, 字体名称, 字符串, 预设宽度        $content = "";        // 将字符串拆分成一个个单字 保存到数组 letter 中        $letter = [];        for ($i = 0; $i < mb_strlen($string, 'UTF-8'); $i++) {            $letter[] = mb_substr($string, $i, 1, 'UTF-8');        }        $line_count = 0;        foreach ($letter as $l) {            $testbox = imagettfbbox($fontsize, $angle, $fontface, $content . ' ' . $l);            // 判断拼接后的字符串是否超过预设的宽度            if (($testbox[2] > $width) && ($content !== "")) {                $line_count++;                if ($max_line && $line_count >= $max_line) {                    $content = mb_substr($content, 0, -1, 'UTF-8') . "...";                    break;                }                $content .= "\n";            }            $content .= $l;        }        return $content;    }    /**     * 海报图文件路径     * @return string     */    private function getPosterPath()    {        if ($this->posterPath) {            return $this->posterPath;        }        // 保存路径        $tempPath = WEB_PATH . 'temp' . '/' . $this->item['app_id'] . '/';        !is_dir($tempPath) && mkdir($tempPath, 0755, true);        return $tempPath . $this->getPosterName();    }    /**     * 海报图文件名称     * @return string     */    private function getPosterName()    {        if (!empty($this->posterName)) {            return $this->posterName;        }        return 'ok_' . md5("{$this->item['item_id']}_{$this->user_id}") . '.png';    }    /**     * 海报图url     * @return string     */    private function getPosterUrl()    {        return $this->posterUrl ?: (\base_url() . 'temp/' . $this->item['app_id'] . '/' . $this->getPosterName());    }}